name: REM-Provenance-Gate

on:
  pull_request:
    paths:
      - 'rem/**'
      - '.github/workflows/rem-gate.yml'
  push:
    branches: [main]

env:
  RUST_VERSION: 1.75.0
  K_FRAMEWORK_VERSION: 6.1.0
  IMAGE: runtimeverificationinc/kframework-k:ubuntu-22.04-${K_FRAMEWORK_VERSION}

jobs:
  build:
    name: Build staticlib & checksum
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-musl

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rem/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('rem/Cargo.lock') }}

      - name: Build staticlib (deterministic + backtrace)
        working-directory: rem
        env:
          RUST_BACKTRACE: 1
        run: |
          cargo build --release --target x86_64-unknown-linux-musl --verbose
          sha256sum target/x86_64-unknown-linux-musl/release/libhelix_rem.a > rem.sha256

      - name: Upload artefact + checksum
        uses: actions/upload-artifact@v4
        with:
          name: helix-rem-${{ github.sha }}
          path: |
            rem/target/x86_64-unknown-linux-musl/release/libhelix_rem.a
            rem/rem.sha256
          - name: Build staticlib (debug panic)
        working-directory: rem
        env:
          RUST_BACKTRACE: full
        run: cargo build --release --target x86_64-unknown-linux-musl --verbose
        continue-on-error: true

      - name: Print panic backtrace
        if: failure()
        run: cat rem/target/x86_64-unknown-linux-musl/release/build/*/output 2>/dev/null || true
  prove:
    name: K-framework proof
    runs-on: ubuntu-latest
    needs: build
    container:
      image: runtimeverificationinc/kframework-k:ubuntu-22.04-6.1.0
    steps:
      - uses: actions/checkout@v4

      - name: Download artefact
        uses: actions/download-artifact@v4
        with:
          name: helix-rem-${{ github.sha }}
          path: rem/

      - name: Verify checksum
        run: cd rem && sha256sum -c rem.sha256

      - name: Run K prove
        run: |
          kompile rem/spec/REM.k --backend llvm -d .build
          kprove rem/spec/REM.k -d .build --verbose

  publish:
    name: Publish signed staticlib
    runs-on: ubuntu-latest
    needs: [build, prove]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artefact
        uses: actions/download-artifact@v4
        with:
          name: helix-rem-${{ github.sha }}

      - name: Publish to GH Packages (generic)
        run: |
          gh release create "rem-${{ github.sha }}" \
            --title "REM staticlib ${{ github.sha }}" \
            --notes "K-proven reference enforcement module" \
            libhelix_rem.a rem.sha256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
